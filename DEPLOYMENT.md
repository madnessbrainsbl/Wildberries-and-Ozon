# Развертывание Teleshop на сервере

## Информация о сервере
- **Домен**: teleshop.su
- **IP-адрес**: По домену
- **Тарифный план**: VDS-KVM-SSD-Разгон-10.0
- **CPU**: 2 ядра
- **RAM**: 4 Гб
- **SSD**: 60 Гб
- **ОС**: Ubuntu 24.04

## Предварительные требования

1. SSH доступ к серверу
2. Настроенные переменные окружения в файле `.env`
3. База данных Supabase с правильной структурой таблиц

## Шаги развертывания

### 1. Первичная настройка сервера

Выполните скрипт первичной настройки (только один раз):

```bash
chmod +x setup-server.sh
./setup-server.sh
```

Этот скрипт:
- Обновит систему
- Установит необходимые пакеты
- Настроит файрвол
- Получит SSL сертификаты от Let's Encrypt

### 2. Настройка базы данных

Подключитесь к вашей базе данных Supabase и выполните SQL скрипт:

```sql
-- Содержимое файла database/create_tables.sql
```

### 3. Настройка переменных окружения

Убедитесь, что в файле `.env` установлены все необходимые переменные:

```env
# Telegram Bot
TELEGRAM_BOT_TOKEN=ваш_токен_бота

# Supabase
VITE_SUPABASE_URL=https://ваш_проект.supabase.co
VITE_SUPABASE_ANON_KEY=ваш_анонимный_ключ
```

### 4. Развертывание приложения

Выполните скрипт развертывания:

```bash
chmod +x deploy.sh
./deploy.sh
```

Этот скрипт:
- Скопирует файлы проекта на сервер
- Установит Docker и Docker Compose (если не установлены)
- Соберет и запустит контейнеры
- Настроит Nginx для проксирования

### 5. Проверка работы

После развертывания проверьте:

1. **Веб-интерфейс**: https://teleshop.su
2. **Telegram бот**: Отправьте /start вашему боту
3. **Mini App**: https://teleshop.su/miniapp/5358ebd1-d90b-4c55-a0ff-f8840f8da283

### 6. Мониторинг

Для проверки статуса контейнеров:

```bash
ssh root@teleshop.su
cd /opt/teleshop
docker-compose -f docker-compose.prod.yml ps
docker-compose -f docker-compose.prod.yml logs -f
```

## Важные замечания

1. **Браузерная автоматизация отключена** на сервере для экономии ресурсов
2. Для работы с маркетплейсами нужно будет реализовать отдельный сервис или использовать API
3. SSL сертификаты автоматически обновляются через certbot

## Обновление приложения

Для обновления просто запустите `./deploy.sh` снова. Скрипт:
- Остановит старые контейнеры
- Скопирует новые файлы
- Пересоберет и запустит обновленные контейнеры

## Резервное копирование

Рекомендуется регулярно делать резервные копии:
- Базы данных Supabase (через панель управления)
- Конфигурационных файлов
- SSL сертификатов

## Устранение неполадок

### Ошибка с базой данных
Если возникает ошибка "column orders.user_id does not exist":
1. Подключитесь к Supabase
2. Выполните SQL из файла `database/create_tables.sql`

### Бот не отвечает
1. Проверьте логи: `docker-compose -f docker-compose.prod.yml logs bot-backend`
2. Убедитесь, что токен бота правильный
3. Проверьте, что webhook не установлен (бот использует polling)

### SSL сертификат не работает
1. Проверьте, что домен правильно настроен
2. Перевыпустите сертификат: `certbot renew --force-renewal`
